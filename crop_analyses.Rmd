---
title: "Crop data analyses"
author: "Roy Sanderson"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("multi_plot.R")
```

## Background
Analyses for the "CHN 2020 STC data including N rates.xlsx" spreadsheet separated by year (2018 or 2019) and use farm as a random effect. Multiple comparison tests also included to show differences between management treatments.

For the data in "CHN 2020 STC data including N rates.xlsx" the design is vaguely like a randomised-block design, in that each column of 3 plots has all three management types randomly assigned. However, the nitrogen treatments are applied in a line. Thus, if the analysis is done separately, for each N treatment, it could be analysed as a randomised block design. However, I'm assuming that both N and management regime (bio, ipm, conv) are of interest. As such, this is not a true randomised block design, and therefore this has been analysed as a fully-randomised setup. However the growth stage (date) can be used as a random effect. As the last growth stage (GS89, 30th July 2020) merely records height, this has been ignored.

```{r crop data 2018 and 2019, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)

crop_data_2018 <- read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                              sheet = "Crop data 2018",
                              skip = 4,
                              na = "-")
colnames(crop_data_2018) <- c("farm", "treatment", "variety", "yield",
                              "sp_wght", "moisture", "N", "protein", "GLA")
crop_data_2018$farm[crop_data_2018$farm == 1] <- "stc"
crop_data_2018$farm[crop_data_2018$farm == 2] <- "nafferton"
crop_data_2018$farm[crop_data_2018$farm == 3] <- "cockle"
crop_data_2018$farm <- as.factor(crop_data_2018$farm)
crop_data_2018$treatment[crop_data_2018$treatment == 1] <- "bio"
crop_data_2018$treatment[crop_data_2018$treatment == 2] <- "ipm"
crop_data_2018$treatment[crop_data_2018$treatment == 3] <- "conv"
crop_data_2018$treatment <- as.factor(crop_data_2018$treatment)
crop_data_2018$variety[crop_data_2018$variety == 1] <- "leeds"
crop_data_2018$variety[crop_data_2018$variety == 2] <- "skyfall"
crop_data_2018$variety <- as.factor(crop_data_2018$variety)

crop_data_2019 <- read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                              sheet = "Crop data 2019",
                              skip = 4,
                              na = "-")
colnames(crop_data_2019) <- c("farm", "treatment", "variety", "yield",
                              "sp_wght", "moisture", "N", "protein", "GLA")
crop_data_2019$farm[crop_data_2019$farm == 1] <- "stc"
crop_data_2019$farm[crop_data_2019$farm == 2] <- "cockle"
crop_data_2019$farm <- as.factor(crop_data_2019$farm)
crop_data_2019$treatment[crop_data_2019$treatment == 1] <- "bio"
crop_data_2019$treatment[crop_data_2019$treatment == 2] <- "ipm"
crop_data_2019$treatment[crop_data_2019$treatment == 3] <- "conv"
crop_data_2019$treatment <- as.factor(crop_data_2019$treatment)
crop_data_2019$variety[crop_data_2019$variety == 1] <- "sundance"
crop_data_2019$variety <- as.factor(crop_data_2019$variety)

```

```{r disease data 2018-2019, echo=FALSE, message=FALSE}
# Trickier as multiple spreadsheets and duplicate column names
# STC first
snake_case <- function(nms) tolower(gsub("[.]", "_", nms))
gs <-  colnames(read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                           sheet = "Disease STC 2018",
                           skip = 3,
                           n_max = 0,
                           .name_repair = "universal"
                  ))
gs <- snake_case(gs)
gs <- str_replace_all(gs, "___", "_")
di <-  colnames(read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                           sheet = "Disease STC 2018",
                           skip = 4,
                           n_max = 0,
                           .name_repair = "universal",
                           range = "C5:L5"
                  ))
di <- snake_case(di)
di <- str_replace_all(di, "___", "_")
di <- str_replace_all(di, "__", "")
gs_di <- str_c(gs, di, sep="_")


disease_stc_2018 <- read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                                sheet = "Disease STC 2018",
                                skip = 4,
                                na = "-")
colnames(disease_stc_2018) <- c("treatment", "variety", gs_di)
disease_stc_2018$treatment[disease_stc_2018$treatment == 1] <- "bio"
disease_stc_2018$treatment[disease_stc_2018$treatment == 2] <- "ipm"
disease_stc_2018$treatment[disease_stc_2018$treatment == 3] <- "conv"
disease_stc_2018$treatment <- as.factor(disease_stc_2018$treatment)
disease_stc_2018$variety[disease_stc_2018$variety == 1] <- "leeds"
disease_stc_2018$variety[disease_stc_2018$variety == 2] <- "skyfall"
disease_stc_2018$variety <- as.factor(disease_stc_2018$variety)
disease_stc_2018$farm <- "stc"

# Format not quite the same for Nafferton and Cockle Park
gs <-  colnames(read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                           sheet = "Disease CP and Naff 2018",
                           skip = 3,
                           n_max = 0,
                           .name_repair = "universal"
                  ))
gs <- snake_case(gs)
gs <- str_replace_all(gs, "___", "_")
di <-  colnames(read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                           sheet = "Disease CP and Naff 2018",
                           skip = 4,
                           n_max = 0,
                           .name_repair = "universal",
                           range = "D5:G5"
                  ))
di <- snake_case(di)
di <- str_replace_all(di, "___", "_")
di <- str_replace_all(di, "__", "")
gs_di <- str_c(gs, di, sep="_")
disease_cpnf_2018 <- read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                                sheet = "Disease CP and Naff 2018",
                                skip = 4,
                                na = "-")
colnames(disease_cpnf_2018) <- c("farm", "treatment", "variety", gs_di)
disease_cpnf_2018$farm[disease_cpnf_2018$farm == 1] <- "nafferton"
disease_cpnf_2018$farm[disease_cpnf_2018$farm == 2] <- "cockle"
disease_cpnf_2018$farm <- as.factor(disease_cpnf_2018$farm)
disease_cpnf_2018$treatment[disease_cpnf_2018$treatment == 1] <- "bio"
disease_cpnf_2018$treatment[disease_cpnf_2018$treatment == 2] <- "ipm"
disease_cpnf_2018$treatment[disease_cpnf_2018$treatment == 3] <- "conv"
disease_cpnf_2018$treatment <- as.factor(disease_cpnf_2018$treatment)
disease_cpnf_2018$variety[disease_cpnf_2018$variety == 1] <- "leeds"
disease_cpnf_2018$variety[disease_cpnf_2018$variety == 2] <- "skyfall"
disease_cpnf_2018$variety <- as.factor(disease_cpnf_2018$variety)


# Format again different for 2019 at only 2 sites
# STC 2019 disease
gs <-  colnames(read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                           sheet = "Disease STC 2019 (standard N)",
                           skip = 3,
                           n_max = 0,
                           .name_repair = "universal"
                  ))
gs <- snake_case(gs)
gs <- str_replace_all(gs, "___", "_")
di <-  colnames(read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                           sheet = "Disease STC 2019 (standard N)",
                           skip = 4,
                           n_max = 0,
                           .name_repair = "universal",
                           range = "B5:C5"
                  ))
di <- snake_case(di)
di <- str_replace_all(di, "___", "_")
di <- str_replace_all(di, "__", "")
gs_di <- str_c(gs, di, sep="_")
disease_stc_2019 <- read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                                sheet = "Disease STC 2019 (standard N)",
                                skip = 4,
                                na = "-")
colnames(disease_stc_2019) <- c("treatment", gs_di)
disease_stc_2019$farm <- "stc"
disease_stc_2019$variety <- "sundance"
disease_stc_2019$treatment[disease_stc_2019$treatment == 1] <- "bio"
disease_stc_2019$treatment[disease_stc_2019$treatment == 2] <- "ipm"
disease_stc_2019$treatment[disease_stc_2019$treatment == 3] <- "conv"
disease_stc_2019$treatment <- as.factor(disease_stc_2019$treatment)


# Cockle Park 2019 disease
gs <-  colnames(read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                           sheet = "Disease CP 2019",
                           skip = 3,
                           n_max = 0,
                           .name_repair = "universal"
                  ))
gs <- snake_case(gs)
gs <- str_replace_all(gs, "___", "_")
di <-  colnames(read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                           sheet = "Disease CP 2019",
                           skip = 4,
                           n_max = 0,
                           .name_repair = "universal",
                           range = "B5:C5"
                  ))
di <- snake_case(di)
di <- str_replace_all(di, "___", "_")
di <- str_replace_all(di, "__", "")
gs_di <- str_c(gs, di, sep="_")
disease_cp_2019 <- read_excel("data/CHN 2018 and 2019 data all sites.xlsx",
                                sheet = "Disease CP 2019",
                                skip = 4,
                                na = "-")
colnames(disease_cp_2019) <- c("treatment", gs_di)
disease_cp_2019$farm <- "cp"
disease_cp_2019$variety <- "sundance" # Not stated, but taken from crop data
disease_cp_2019$treatment[disease_cp_2019$treatment == 1] <- "bio"
disease_cp_2019$treatment[disease_cp_2019$treatment == 2] <- "ipm"
disease_cp_2019$treatment[disease_cp_2019$treatment == 3] <- "conv"
disease_cp_2019$treatment <- as.factor(disease_cp_2019$treatment)


```

Data are a bit of a mess, especially disease. Probably sensible to convert everything to tidy format to make easier to manage.

```{r disease tidy 2018, echo=FALSE, message=FALSE}
disease_cpnf_2018_lng <- pivot_longer(disease_cpnf_2018,
                                      cols = starts_with("gs"),
                                      names_to = "gsdis",
                                      values_to = "severity")
disease_stc_2018_lng <- pivot_longer(disease_stc_2018,
                                      cols = starts_with("gs"),
                                      names_to = "gsdis",
                                      values_to = "severity")

# Deconstruct growth stages and diseases
disease_cpnf_2018_lng <- disease_cpnf_2018_lng %>%
  mutate(gs = as.numeric(str_sub(gsdis, 4, 5)),
         pathogen = str_extract(gsdis, "mildew|septoria"),
         year = 2018) %>% 
  select(-gsdis)

disease_stc_2018_lng <- disease_stc_2018_lng %>%
  mutate(gs = as.numeric(str_sub(gsdis, 4, 5)),
         pathogen = str_extract(gsdis, "mildew|septoria"),
         year = 2018) %>% 
  select(-gsdis)
       
disease_2018 <- rbind(disease_cpnf_2018_lng, disease_stc_2018_lng)
```

Do the same for 2019

```{r disease tidy 2019, echo=FALSE, message=FALSE}
disease_cp_2019_lng <- pivot_longer(disease_cp_2019,
                                      cols = starts_with("gs"),
                                      names_to = "gsdis",
                                      values_to = "severity")
disease_stc_2019_lng <- pivot_longer(disease_stc_2019,
                                      cols = starts_with("gs"),
                                      names_to = "gsdis",
                                      values_to = "severity")

# Deconstruct growth stages and diseases
disease_cp_2019_lng <- disease_cp_2019_lng %>%
  mutate(gs = as.numeric(str_sub(gsdis, 3, 4)), # Not the same as before
         pathogen = str_extract(gsdis, "mildew|septoria"),
         year = 2019) %>% 
  select(-gsdis)

disease_stc_2019_lng <- disease_stc_2019_lng %>%
  mutate(gs = as.numeric(str_sub(gsdis, 4, 5)),
         pathogen = str_extract(gsdis, "mildew|septoria"),
         year = 2019) %>% 
  select(-gsdis)
       
disease_2019 <- rbind(disease_cp_2019_lng, disease_stc_2019_lng)
```

May as well merge into one data.frame for both years if needed

```{r merge disease years, echo=FALSE, message=FALSE}
disease <- rbind(disease_2018, disease_2019)
```



## Basic crop graphs
Check on patterns in crops

```{r crop graphs basics, echo=FALSE, message=FALSE}
theme_set(theme_classic())
p1 <- ggplot(crop_data_2018, aes(x = farm, y=yield, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Yield 2018")
p2 <- ggplot(crop_data_2019, aes(x = farm, y=yield, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Yield 2019")
multiplot(p1, p2, cols=2)

p1 <- ggplot(crop_data_2018, aes(x = farm, y=sp_wght, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Specific weight 2018")
p2 <- ggplot(crop_data_2019, aes(x = farm, y=sp_wght, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Specific weight 2019")
multiplot(p1, p2, cols=2)

p1 <- ggplot(crop_data_2018, aes(x = farm, y=moisture, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Grain moisture content 2018")
p2 <- ggplot(crop_data_2019, aes(x = farm, y=moisture, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Grain moisture content 2019")
multiplot(p1, p2, cols=2)

p1 <- ggplot(crop_data_2018, aes(x = farm, y=N, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Grain nitrogen content 2018")
p2 <- filter(crop_data_2019, farm == "stc") %>% 
  ggplot(aes(x = farm, y=N, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Grain nitrogen content 2019")
multiplot(p1, p2, cols=2)

p1 <- ggplot(crop_data_2018, aes(x = farm, y=protein, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Grain protein content 2018")
p2 <- ggplot(crop_data_2019, aes(x = farm, y=protein, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Grain protein content 2019")
multiplot(p1, p2, cols=2)


```

## Linear mixed models
Treat farm as a random variable, as presumably it is treatment effects that are of interest.

### Yield
#### Yield 2018
```{r mixed models, echo=FALSE, warning=FALSE, message=FALSE}
library(nlme)
library(multcomp)
library(effects)
yield_2018_lme <- lme(yield ~ treatment, random = ~ 1 | farm, data=crop_data_2018)
summary(yield_2018_lme)
summary(glht(yield_2018_lme, linfct = mcp(treatment = "Tukey")))
#cints <- (confint(glht(yield_2018_lme, linfct = mcp(treatment = "Tukey"))))[[10]]
#data.frame(cints) # Neater printing
#plot(allEffects(yield_2018_lme), lines=list(col="black"))
```

#### Yield 2019
```{r echo=FALSE, warning=FALSE, message=FALSE}
yield_2019_lme <- lme(yield ~ treatment, random = ~ 1 | farm, data=crop_data_2019)
summary(yield_2019_lme)
summary(glht(yield_2019_lme, linfct = mcp(treatment = "Tukey")))
#cints <- (confint(glht(yield_2019_lme, linfct = mcp(treatment = "Tukey"))))[10]
#data.frame(cints)
```

#### Specific weight 2018
```{r echo=FALSE, warning=FALSE, message=FALSE}

lme_summary <- function(fix_form, data) {
  res_lme <- lme(fix_form, random = ~ 1 | farm, data=data)
  print(summary(res_lme))
  print(summary(glht(res_lme, linfct = mcp(treatment = "Tukey"))))
#  cints <- (confint(glht(res_lme, linfct = mcp(treatment = "Tukey"))))[10]
#  data.frame(cints)
}

lme_summary(formula(sp_wght ~ treatment), data=crop_data_2018)
```

#### Specific weight 2019
```{r echo=FALSE}
lme_summary(formula(sp_wght ~ treatment), data=crop_data_2019)
```

#### Moisture 2018
```{r echo=FALSE}
lme_summary(formula(moisture ~ treatment), data=crop_data_2018)
```

#### Moisture 2019
```{r echo=FALSE}
lme_summary(formula(moisture ~ treatment), data=crop_data_2019)
```

#### Nitrogen 2018
```{r echo=FALSE}
lme_summary(formula(N ~ treatment), data=crop_data_2018)
```

#### Nitrogen 2019
Only available for STC in 2019 therefore linear model rather than mixed-effects model.
```{r echo=FALSE}
#lme_summary(formula(N ~ treatment), data=crop_data_2019)
n_2019_lm <- lm(N ~ treatment, data=crop_data_2019[1:15,]) # only stc
summary(n_2019_lm)
summary(glht(n_2019_lm, linfct = mcp(treatment = "Tukey")))
#cints <- (confint(glht(n_2019_lm, linfct = mcp(treatment = "Tukey"))))[10]
#data.frame(cints)
```

#### Protein 2018
```{r echo=FALSE}
lme_summary(formula(protein ~ treatment), data=crop_data_2018)
```

#### Protein 2019
```{r echo=FALSE}
lme_summary(formula(protein ~ treatment), data=crop_data_2019)
```

## STC 2020 data analysis
This is for the data in the "CHN 2020 STC data including N rates.xlsx" spreadsheet.

```{r read in STC data for 2020 block expt, echo=FALSE, message=FALSE}
yield_quality <- read_excel("data/CHN 2020 STC data including N rates.xlsx",
                              sheet = "YIELD & QUALITY",
                              skip = 6,
                              range = "A7:Q43",
                              na = "-")
colnames(yield_quality) <- c("plot", "treatment", "N", "yield", "lodging", "brackling",
                             "moisture", "dm", "sp_wght", "tgw", "n_content",
                             "protein_content", "grain_2.8", "grain_2.5_2.8",
                             "grain_2.2_2.5", "grain_2.0_2.2", "grain_2.0")
# Need to allocate block numbers to plots; These are not 'true' blocks as they
# are not independent of N applications, so probably best ignored for analysis
yield_quality$block <- NA
yield_quality$block[yield_quality$plot %in% 1:3] <- "1"
yield_quality$block[yield_quality$plot %in% 4:6] <- "2"
yield_quality$block[yield_quality$plot %in% 7:9] <- "3"
yield_quality$block[yield_quality$plot %in% 10:12] <- "4"
yield_quality$block[yield_quality$plot %in% 13:15] <- "1"
yield_quality$block[yield_quality$plot %in% 16:18] <- "2"
yield_quality$block[yield_quality$plot %in% 19:21] <- "3"
yield_quality$block[yield_quality$plot %in% 22:24] <- "4"
yield_quality$block[yield_quality$plot %in% 25:27] <- "1"
yield_quality$block[yield_quality$plot %in% 28:30] <- "2"
yield_quality$block[yield_quality$plot %in% 31:33] <- "3"
yield_quality$block[yield_quality$plot %in% 34:36] <- "4"
yield_quality$block <- as.factor(yield_quality$block)

yield_quality$treatment[yield_quality$treatment == 1] <- "bio"
yield_quality$treatment[yield_quality$treatment == 2] <- "ipm"
yield_quality$treatment[yield_quality$treatment == 3] <- "conv"
yield_quality$treatment <- as.factor(yield_quality$treatment)
yield_quality$N <- as.factor(yield_quality$N) # Excel unclear on exact amounts

# Disease data for 2020
# Growth stages
gs_names <- read_excel("data/CHN 2020 STC data including N rates.xlsx",
                              sheet = "DISEASE ASSESSMENTS",
                              skip = 4,
                              range = "D5:W5",
                              na = "-")
gs_names <- colnames(gs_names)
curr_name <- gs_names[1]
for (i in 1:length(gs_names)){
  if(str_sub(gs_names[i], 1, 3) == "..."){
    gs_names[i] <- curr_name
  } else {
    curr_name <- gs_names[i]
  }
}
str_sub(gs_names, 3, 3) <- ""

# Dates
date_names <- read_excel("data/CHN 2020 STC data including N rates.xlsx",
                              sheet = "DISEASE ASSESSMENTS",
                              skip = 5,
                              range = "D6:W6",
                              na = "-")
date_names <- colnames(date_names)
date_name <- date_names[1]
for (i in 1:length(date_names)){
  if(str_sub(date_names[i], 1, 3) == "..."){
    date_names[i] <- curr_name
  } else {
    curr_name <- date_names[i]
  }
}
str_sub(date_names, 3, 3) <- ""
date_names <- as.Date(as.numeric(date_names), origin="2008-06-01") # origin trial and error

# Actual disease data
disease_raw <- read_excel("data/CHN 2020 STC data including N rates.xlsx",
                          sheet = "DISEASE ASSESSMENTS",
                          skip = 6,
                          na = "-",
                          .name_repair = "universal")
di <- snake_case(colnames(disease_raw) <- str_to_lower(colnames(disease_raw)))
di <- str_replace_all(di, "_____", "")
di <- str_replace_all(di, "____", "")
di <- str_replace_all(di, "__", "")
di <- str_replace_all(di, "_", "")

da_gs_di <- str_c(date_names, gs_names, di[-(1:3)])

colnames(disease_raw) <- c(di[1:3], da_gs_di)

# Convert to long format
disease_lng <- pivot_longer(disease_raw,
                            cols = 4:23,
                            names_to = "health",
                            values_to = "pcnt")
disease_lng$date <- as.Date(str_sub(disease_lng$health, 1, 10))
disease_lng$gs   <- str_sub(disease_lng$health, 11, 14)
disease_lng$health <- str_extract(disease_lng$health, "septoria|mildew|yellowrust|flaggla|greenleafarea")
colnames(disease_lng)[3] <- "N"  # be consistent with earlier
disease_lng$N <- as.factor(disease_lng$N)
disease_lng$treatment[disease_lng$treatment == 1] <- "bio"
disease_lng$treatment[disease_lng$treatment == 2] <- "ipm"
disease_lng$treatment[disease_lng$treatment == 3] <- "conv"

# Not interested in GS89 as only contains height
disease_lng <- filter(disease_lng, gs != "GS89")
```

### Broad patterns in crop yield and quality
General patterns for STC 2020 crop data. Lodging figures not shown as nearly all values are zero. Nitrogen has been coded as 1, 2 or 3 as actual applications in spreadsheet do not agree between the "TRIAL LAYOUT" vs the "YIELD & QUALITY" or "DISEASE ASSESSMENT" tabs.

```{r, echo = FALSE}
p1 <- ggplot(yield_quality, aes(x = N, y=yield, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Grain yield (t/ha)")
p2 <- ggplot(yield_quality, aes(x = N, y=lodging, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Root lodging (%)")
p3 <- ggplot(yield_quality, aes(x = N, y=brackling, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Brackling (%)")
p4 <- ggplot(yield_quality, aes(x = N, y=moisture, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Moisture (%)")
p5 <- ggplot(yield_quality, aes(x = N, y=dm, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Dry matter (%)")

multiplot(p1, p3, p4, p5, cols=2)
```

General patterns for some additional information on grain chemistry collected by NIAB.

```{r, echo = FALSE}
p1 <- ggplot(yield_quality, aes(x = N, y=sp_wght, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Specific weight (kg/hl)")
p2 <- ggplot(yield_quality, aes(x = N, y=tgw, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Thousand grain weight (g)")
p3 <- ggplot(yield_quality, aes(x = N, y=n_content, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Nitrogen content (g/100g)")
p4 <- ggplot(yield_quality, aes(x = N, y=protein_content, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Protein content (g/100g)")

multiplot(p1, p2, p3, p4, cols=2)
```

Physical characteristics of harvested grain measured by NIAB

```{r, echo = FALSE}
p1 <- ggplot(yield_quality, aes(x = N, y=grain_2.8, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Grain >2.8 mm")
p2 <- ggplot(yield_quality, aes(x = N, y=grain_2.5_2.8, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Grain 2.5-2.8 mm")
p3 <- ggplot(yield_quality, aes(x = N, y=grain_2.2_2.5, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Grain 2.2-2.5 mm")
p4 <- ggplot(yield_quality, aes(x = N, y=grain_2.0_2.2, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Grain 2.0-2.2 mm")
p5 <- ggplot(yield_quality, aes(x = N, y=grain_2.0, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Grain <2.0 mm")

multiplot(p1, p3, p5, p2, p4, cols=2)
```

### Broad patterns in disease at STC 2020
These data could be plotted for each growth stage, although that would be quite over-whelming in terms of numbers of graphs. These are for GS71, i.e. 10th July 2020.

```{r, echo=FALSE, message=FALSE}
p1 <- filter(disease_lng, health == "septoria" & gs == "GS71") %>% 
  ggplot(aes(x = N, y=pcnt, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Septoria (%)")
p2 <- filter(disease_lng, health == "yellowrust" & gs == "GS71") %>% 
  ggplot(aes(x = N, y=pcnt, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Yellow rust (%)")
p3 <- filter(disease_lng, health == "mildew" & gs == "GS71") %>% 
  ggplot(aes(x = N, y=pcnt, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Mildew (%)")
p4 <- filter(disease_lng, health == "greenleafarea" & gs == "GS71") %>% 
  ggplot(aes(x = N, y=pcnt, colour=treatment)) +
  geom_boxplot() +
  ggtitle("Green leaf area (%)")

multiplot(p1, p2, p3, p4, cols=2)
```

Changes over time

```{r}
tmp <- filter(disease_lng, health == "septoria") %>%
  group_by(treatment, date) %>% 
  summarise(
    meanpcnt = mean(pcnt, na.rm = TRUE),
    sepcnt = sd(pcnt, na.rm = TRUE)/sqrt(n())
  )
  
p1 <- ggplot(tmp, aes(x = date, y = meanpcnt, colour=treatment)) +
  geom_point() +
  geom_line() + 
  geom_errorbar(aes(ymin = meanpcnt - sepcnt,
                    ymax = meanpcnt + sepcnt,
                    width = 0.5))

tmp <- filter(disease_lng, health == "septoria") %>%
  group_by(N, date) %>% 
  summarise(
    meanpcnt = mean(pcnt, na.rm = TRUE),
    sepcnt = sd(pcnt, na.rm = TRUE)/sqrt(n())
  )
  
p2 <- ggplot(tmp, aes(x = date, y = meanpcnt, colour=N)) +
  geom_point() +
  geom_line() + 
  geom_errorbar(aes(ymin = meanpcnt - sepcnt,
                    ymax = meanpcnt + sepcnt,
                    width = 0.5))
multiplot(p1, p2, cols=2)
```

